services:
  postgres-synapse:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_SYNAPSE_DB}
      POSTGRES_USER: ${POSTGRES_SYNAPSE_USER}
      POSTGRES_PASSWORD: ${POSTGRES_SYNAPSE_PASSWORD}
    volumes:
      - postgres-synapse:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SYNAPSE_USER} -d ${POSTGRES_SYNAPSE_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-sliding-sync:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_SLIDING_SYNC_DB}
      POSTGRES_USER: ${POSTGRES_SLIDING_SYNC_USER}
      POSTGRES_PASSWORD: ${POSTGRES_SLIDING_SYNC_PASSWORD}
    volumes:
      - postgres-sliding-sync:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SLIDING_SYNC_USER} -d ${POSTGRES_SLIDING_SYNC_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-synapse-mas:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_SYNAPSE_MAS_DB}
      POSTGRES_USER: ${POSTGRES_SYNAPSE_MAS_USER}
      POSTGRES_PASSWORD: ${POSTGRES_SYNAPSE_MAS_PASSWORD}
    volumes:
      - postgres-synapse-mas:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SYNAPSE_MAS_USER} -d ${POSTGRES_SYNAPSE_MAS_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  mas-config-init:
    image: ghcr.io/element-hq/matrix-authentication-service:latest-debug
    user: "0:0"
    restart: "no"
    environment:
      POSTGRES_SYNAPSE_MAS_USER: ${POSTGRES_SYNAPSE_MAS_USER}
      POSTGRES_SYNAPSE_MAS_PASSWORD: ${POSTGRES_SYNAPSE_MAS_PASSWORD}
      POSTGRES_SYNAPSE_MAS_DB: ${POSTGRES_SYNAPSE_MAS_DB}
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      SYNAPSE_FQDN: ${SYNAPSE_FQDN}
      SYNAPSE_MAS_FQDN: ${SYNAPSE_MAS_FQDN}
      SYNAPSE_MAS_SECRET: ${SYNAPSE_MAS_SECRET}
      SYNAPSE_API_ADMIN_TOKEN: ${SYNAPSE_API_ADMIN_TOKEN}
      SYNAPSE_FRIENDLY_SERVER_NAME: ${SYNAPSE_FRIENDLY_SERVER_NAME}
      SMTP_USER: ${SMTP_USER}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      KEYCLOAK_FQDN: ${KEYCLOAK_FQDN}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      KEYCLOAK_REALM_IDENTIFIER: ${KEYCLOAK_REALM_IDENTIFIER}
      KEYCLOAK_UPSTREAM_OAUTH_PROVIDER_ID: ${KEYCLOAK_UPSTREAM_OAUTH_PROVIDER_ID}
    entrypoint: ["/busybox/sh", "/scripts/mas-init.sh"]
    volumes:
      - mas-data:/data
      - ./scripts/mas-init.sh:/scripts/mas-init.sh:ro

  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      POSTGRES_SYNAPSE_USER: ${POSTGRES_SYNAPSE_USER}
      POSTGRES_SYNAPSE_PASSWORD: ${POSTGRES_SYNAPSE_PASSWORD}
      POSTGRES_SYNAPSE_DB: ${POSTGRES_SYNAPSE_DB}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_REQUIRE_TRANSPORT_SECURITY: ${SMTP_REQUIRE_TRANSPORT_SECURITY}
      SMTP_NOTIFY_FROM: ${SMTP_NOTIFY_FROM}
      SYNAPSE_FRIENDLY_SERVER_NAME: ${SYNAPSE_FRIENDLY_SERVER_NAME}
      SYNAPSE_MAS_FQDN: ${SYNAPSE_MAS_FQDN}
      SYNAPSE_MAS_SECRET: ${SYNAPSE_MAS_SECRET}
      SYNAPSE_API_ADMIN_TOKEN: ${SYNAPSE_API_ADMIN_TOKEN}
      KEYCLOAK_FQDN: ${KEYCLOAK_FQDN}
      KEYCLOAK_REALM_IDENTIFIER: ${KEYCLOAK_REALM_IDENTIFIER}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
    entrypoint: ["/bin/sh", "/scripts/synapse-entrypoint.sh"]
    volumes:
      - synapse-data:/data
      - synapse-media:/media_store
      - bridge-registrations:/bridges:ro
      - ./scripts/synapse-entrypoint.sh:/scripts/synapse-entrypoint.sh:ro
    depends_on:
      postgres-synapse:
        condition: service_healthy
      synapse-mass-authentication-service:
        condition: service_started
      whatsapp-init:
        condition: service_completed_successfully
      telegram-init:
        condition: service_completed_successfully
      discord-init:
        condition: service_completed_successfully
      slack-init:
        condition: service_completed_successfully
      meta-init:
        condition: service_completed_successfully
      linkedin-init:
        condition: service_completed_successfully
      maubot-init:
        condition: service_completed_successfully
      hookshot-init:
        condition: service_completed_successfully

  sliding-sync:
    image: ghcr.io/matrix-org/sliding-sync:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
      postgres-sliding-sync:
        condition: service_healthy
    environment:
      SYNCV3_SERVER: ${SYNAPSE_FQDN}
      SYNCV3_DB: "host=postgres-sliding-sync sslmode=disable port=5432 dbname=${POSTGRES_SLIDING_SYNC_DB} user=${POSTGRES_SLIDING_SYNC_USER} password=${POSTGRES_SLIDING_SYNC_PASSWORD}"
      SYNCV3_SECRET: ${SLIDING_SYNC_SECRET}
      SYNCV3_BINDADDR: 0.0.0.0:8009

  synapse-mass-authentication-service:
    image: ghcr.io/element-hq/matrix-authentication-service:latest
    restart: unless-stopped
    command: ["server", "--config", "/data/config.yaml"]
    depends_on:
      mas-config-init:
        condition: service_completed_successfully
      postgres-synapse-mas:
        condition: service_healthy
    volumes:
      - mas-data:/data

  nginx:
    image: nginx:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
      synapse-mass-authentication-service:
        condition: service_started
    environment:
      SYNAPSE_FQDN: ${SYNAPSE_FQDN}
      SYNAPSE_SYNC_FQDN: ${SYNAPSE_SYNC_FQDN}
      SYNAPSE_MAS_FQDN: ${SYNAPSE_MAS_FQDN}
      AUTHENTICATION_ISSUER: ${AUTHENTICATION_ISSUER}
    entrypoint: ["/bin/sh", "/scripts/nginx-entrypoint.sh"]
    volumes:
      - ./scripts/nginx-entrypoint.sh:/scripts/nginx-entrypoint.sh:ro

  postgres-bridges:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: mautrix_whatsapp
      POSTGRES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
    volumes:
      - postgres-bridges:/var/lib/postgresql/data
    entrypoint: ["/bin/sh", "-c", "printf 'CREATE DATABASE mautrix_telegram;\\nCREATE DATABASE mautrix_discord;\\nCREATE DATABASE mautrix_slack;\\nCREATE DATABASE mautrix_meta;\\nCREATE DATABASE mautrix_linkedin;\\nCREATE DATABASE maubot;\\nCREATE DATABASE postmoogle;\\n' > /docker-entrypoint-initdb.d/create-bridge-dbs.sql && exec docker-entrypoint.sh postgres"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_BRIDGES_USER} -d mautrix_whatsapp"]
      interval: 5s
      timeout: 5s
      retries: 10

  whatsapp-init:
    image: dock.mau.dev/mautrix/whatsapp:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "/scripts/whatsapp-init.sh"]
    volumes:
      - mautrix-whatsapp-data:/data
      - bridge-registrations:/registrations
      - ./scripts/whatsapp-init.sh:/scripts/whatsapp-init.sh:ro

  telegram-init:
    image: dock.mau.dev/mautrix/telegram:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
      TELEGRAM_API_ID: ${TELEGRAM_API_ID}
      TELEGRAM_API_HASH: ${TELEGRAM_API_HASH}
    entrypoint: ["/bin/bash", "/scripts/telegram-init.sh"]
    volumes:
      - mautrix-telegram-data:/data
      - bridge-registrations:/registrations
      - ./scripts/telegram-init.sh:/scripts/telegram-init.sh:ro

  discord-init:
    image: dock.mau.dev/mautrix/discord:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "/scripts/discord-init.sh"]
    volumes:
      - mautrix-discord-data:/data
      - bridge-registrations:/registrations
      - ./scripts/discord-init.sh:/scripts/discord-init.sh:ro

  slack-init:
    image: dock.mau.dev/mautrix/slack:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "/scripts/slack-init.sh"]
    volumes:
      - mautrix-slack-data:/data
      - bridge-registrations:/registrations
      - ./scripts/slack-init.sh:/scripts/slack-init.sh:ro

  meta-init:
    image: dock.mau.dev/mautrix/meta:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "/scripts/meta-init.sh"]
    volumes:
      - mautrix-meta-data:/data
      - bridge-registrations:/registrations
      - ./scripts/meta-init.sh:/scripts/meta-init.sh:ro

  linkedin-init:
    image: dock.mau.dev/mautrix/linkedin:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "/scripts/linkedin-init.sh"]
    volumes:
      - mautrix-linkedin-data:/data
      - bridge-registrations:/registrations
      - ./scripts/linkedin-init.sh:/scripts/linkedin-init.sh:ro

  maubot-init:
    image: dock.mau.dev/maubot/maubot:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      SYNAPSE_FQDN: ${SYNAPSE_FQDN}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      MAUBOT_ADMIN_PASSWORD: ${MAUBOT_ADMIN_PASSWORD}
    entrypoint: ["/bin/bash", "/scripts/maubot-init.sh"]
    volumes:
      - maubot-data:/data
      - bridge-registrations:/registrations
      - ./scripts/maubot-init.sh:/scripts/maubot-init.sh:ro

  hookshot-init:
    image: halfshot/matrix-hookshot:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/sh", "/scripts/hookshot-init.sh"]
    volumes:
      - hookshot-data:/data
      - bridge-registrations:/registrations
      - ./scripts/hookshot-init.sh:/scripts/hookshot-init.sh:ro

  mautrix-whatsapp:
    image: dock.mau.dev/mautrix/whatsapp:latest
    restart: unless-stopped
    depends_on:
      whatsapp-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-whatsapp-data:/data

  mautrix-telegram:
    image: dock.mau.dev/mautrix/telegram:latest
    restart: unless-stopped
    depends_on:
      telegram-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-telegram-data:/data

  mautrix-discord:
    image: dock.mau.dev/mautrix/discord:latest
    restart: unless-stopped
    depends_on:
      discord-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-discord-data:/data

  mautrix-slack:
    image: dock.mau.dev/mautrix/slack:latest
    restart: unless-stopped
    depends_on:
      slack-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-slack-data:/data

  mautrix-meta:
    image: dock.mau.dev/mautrix/meta:latest
    restart: unless-stopped
    depends_on:
      meta-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-meta-data:/data

  mautrix-linkedin:
    image: dock.mau.dev/mautrix/linkedin:latest
    restart: unless-stopped
    depends_on:
      linkedin-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-linkedin-data:/data

  maubot:
    image: dock.mau.dev/maubot/maubot:latest
    restart: unless-stopped
    depends_on:
      maubot-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - maubot-data:/data

  hookshot:
    image: halfshot/matrix-hookshot:latest
    restart: unless-stopped
    depends_on:
      hookshot-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    command: ["node", "/usr/bin/matrix-hookshot/App/BridgeApp.js", "--config", "/data/config.yml", "--registration", "/data/registration.yml"]
    volumes:
      - hookshot-data:/data

  postmoogle:
    image: registry.gitlab.com/etke.cc/postmoogle:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
      postgres-bridges:
        condition: service_healthy
    environment:
      POSTMOOGLE_HOMESERVER: http://synapse:8008
      POSTMOOGLE_LOGIN: postmoogle
      POSTMOOGLE_SHAREDSECRET: ${SYNAPSE_API_ADMIN_TOKEN}
      POSTMOOGLE_DOMAINS: ${SYNAPSE_SERVER_NAME}
      POSTMOOGLE_PORT: "25"
      POSTMOOGLE_DATA_SECRET: ${POSTMOOGLE_DATA_SECRET}
      POSTMOOGLE_DB_DSN: "postgres://${POSTGRES_BRIDGES_USER}:${POSTGRES_BRIDGES_PASSWORD}@postgres-bridges:5432/postmoogle?sslmode=disable"
      POSTMOOGLE_DB_DIALECT: postgres
      POSTMOOGLE_ADMINS: ${BRIDGE_ADMIN_USER}
      POSTMOOGLE_LOGLEVEL: info
    ports:
      - "25:25"

  dimension:
    image: turt2live/matrix-dimension:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
      DIMENSION_ACCESS_TOKEN: ${DIMENSION_ACCESS_TOKEN}
      DIMENSION_PUBLIC_URL: ${DIMENSION_PUBLIC_URL}
    entrypoint: ["/bin/sh", "/scripts/dimension-entrypoint.sh"]
    volumes:
      - dimension-data:/data
      - ./scripts/dimension-entrypoint.sh:/scripts/dimension-entrypoint.sh:ro

volumes:
  postgres-synapse:
  postgres-sliding-sync:
  postgres-synapse-mas:
  synapse-data:
  synapse-media:
  mas-data:
  postgres-bridges:
  bridge-registrations:
  mautrix-whatsapp-data:
  mautrix-telegram-data:
  mautrix-discord-data:
  mautrix-slack-data:
  mautrix-meta-data:
  mautrix-linkedin-data:
  maubot-data:
  hookshot-data:
  dimension-data:
