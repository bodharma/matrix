services:
  postgres-synapse:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_SYNAPSE_DB}
      POSTGRES_USER: ${POSTGRES_SYNAPSE_USER}
      POSTGRES_PASSWORD: ${POSTGRES_SYNAPSE_PASSWORD}
    volumes:
      - postgres-synapse:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SYNAPSE_USER} -d ${POSTGRES_SYNAPSE_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-sliding-sync:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_SLIDING_SYNC_DB}
      POSTGRES_USER: ${POSTGRES_SLIDING_SYNC_USER}
      POSTGRES_PASSWORD: ${POSTGRES_SLIDING_SYNC_PASSWORD}
    volumes:
      - postgres-sliding-sync:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SLIDING_SYNC_USER} -d ${POSTGRES_SLIDING_SYNC_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-synapse-mas:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_SYNAPSE_MAS_DB}
      POSTGRES_USER: ${POSTGRES_SYNAPSE_MAS_USER}
      POSTGRES_PASSWORD: ${POSTGRES_SYNAPSE_MAS_PASSWORD}
    volumes:
      - postgres-synapse-mas:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SYNAPSE_MAS_USER} -d ${POSTGRES_SYNAPSE_MAS_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  mas-config-init:
    image: ghcr.io/element-hq/matrix-authentication-service:latest-debug
    user: "0:0"
    restart: "no"
    environment:
      POSTGRES_SYNAPSE_MAS_USER: ${POSTGRES_SYNAPSE_MAS_USER}
      POSTGRES_SYNAPSE_MAS_PASSWORD: ${POSTGRES_SYNAPSE_MAS_PASSWORD}
      POSTGRES_SYNAPSE_MAS_DB: ${POSTGRES_SYNAPSE_MAS_DB}
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      SYNAPSE_FQDN: ${SYNAPSE_FQDN}
      SYNAPSE_MAS_FQDN: ${SYNAPSE_MAS_FQDN}
      SYNAPSE_MAS_SECRET: ${SYNAPSE_MAS_SECRET}
      SYNAPSE_API_ADMIN_TOKEN: ${SYNAPSE_API_ADMIN_TOKEN}
      SYNAPSE_FRIENDLY_SERVER_NAME: ${SYNAPSE_FRIENDLY_SERVER_NAME}
      SMTP_USER: ${SMTP_USER}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      KEYCLOAK_FQDN: ${KEYCLOAK_FQDN}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      KEYCLOAK_REALM_IDENTIFIER: ${KEYCLOAK_REALM_IDENTIFIER}
      KEYCLOAK_UPSTREAM_OAUTH_PROVIDER_ID: ${KEYCLOAK_UPSTREAM_OAUTH_PROVIDER_ID}
    entrypoint: ["/busybox/sh", "-c", "if [ -f /data/config.yaml ]; then\n  echo 'Config already exists, skipping generation'\n  exit 0\nfi\necho 'Generating MAS config...'\nmas-cli config generate --output /data/config.yaml\nsed -i \"s|uri: postgresql://.*|uri: postgresql://$${POSTGRES_SYNAPSE_MAS_USER}:$${POSTGRES_SYNAPSE_MAS_PASSWORD}@postgres-synapse-mas:5432/$${POSTGRES_SYNAPSE_MAS_DB}|\" /data/config.yaml\nsed -i \"s|from: .*Authentication Service.*|from: '\\\"$${SYNAPSE_FRIENDLY_SERVER_NAME}\\\" <$${SMTP_USER}>'|\" /data/config.yaml\nsed -i \"s|reply_to: .*Authentication Service.*|reply_to: '\\\"$${SYNAPSE_FRIENDLY_SERVER_NAME}\\\" <$${ADMIN_EMAIL}>'|\" /data/config.yaml\nsed -i \"s|homeserver: localhost:8008|homeserver: $${SYNAPSE_SERVER_NAME}|\" /data/config.yaml\nsed -i \"s|endpoint: http://localhost:8008/|endpoint: $${SYNAPSE_FQDN}|\" /data/config.yaml\nsed -i '/^matrix:/,/^[^ ]/{/^  secret:/s|secret: .*|secret: '\"$${SYNAPSE_API_ADMIN_TOKEN}\"'|}' /data/config.yaml\nsed -i \"s|public_base: http://\\[::]:8080/|public_base: $${SYNAPSE_MAS_FQDN}/|\" /data/config.yaml\nsed -i \"s|issuer: http://\\[::]:8080/|issuer: $${SYNAPSE_MAS_FQDN}/|\" /data/config.yaml\nsed -i '/^passwords:/{n;s/enabled: true/enabled: false/}' /data/config.yaml\ncat >> /data/config.yaml <<ENDAPPEND\nclients:\n  - client_id: 0000000000000000000SYNAPSE\n    client_auth_method: client_secret_basic\n    client_secret: \"$${SYNAPSE_MAS_SECRET}\"\nupstream_oauth2:\n  providers:\n    - id: \"$${KEYCLOAK_UPSTREAM_OAUTH_PROVIDER_ID}\"\n      issuer: \"$${KEYCLOAK_FQDN}/realms/$${KEYCLOAK_REALM_IDENTIFIER}\"\n      token_endpoint_auth_method: client_secret_basic\n      client_id: \"$${KEYCLOAK_CLIENT_ID}\"\n      client_secret: \"$${KEYCLOAK_CLIENT_SECRET}\"\n      scope: \"openid profile email\"\n      claims_imports:\n        localpart:\n          action: require\n          template: \"{{ user.preferred_username }}\"\n        displayname:\n          action: suggest\n          template: \"{{ user.name }}\"\n        email:\n          action: suggest\n          template: \"{{ user.email }}\"\n          set_email_verification: always\nENDAPPEND\nchown -R 65532:65532 /data\necho 'MAS config generated successfully'"]
    volumes:
      - mas-data:/data

  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      POSTGRES_SYNAPSE_USER: ${POSTGRES_SYNAPSE_USER}
      POSTGRES_SYNAPSE_PASSWORD: ${POSTGRES_SYNAPSE_PASSWORD}
      POSTGRES_SYNAPSE_DB: ${POSTGRES_SYNAPSE_DB}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_REQUIRE_TRANSPORT_SECURITY: ${SMTP_REQUIRE_TRANSPORT_SECURITY}
      SMTP_NOTIFY_FROM: ${SMTP_NOTIFY_FROM}
      SYNAPSE_FRIENDLY_SERVER_NAME: ${SYNAPSE_FRIENDLY_SERVER_NAME}
      SYNAPSE_MAS_FQDN: ${SYNAPSE_MAS_FQDN}
      SYNAPSE_MAS_SECRET: ${SYNAPSE_MAS_SECRET}
      SYNAPSE_API_ADMIN_TOKEN: ${SYNAPSE_API_ADMIN_TOKEN}
      KEYCLOAK_FQDN: ${KEYCLOAK_FQDN}
      KEYCLOAK_REALM_IDENTIFIER: ${KEYCLOAK_REALM_IDENTIFIER}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
    entrypoint: ["/bin/sh", "-c", "mkdir -p /data/config && cat > /data/config/homeserver.yaml <<ENDCONF\nserver_name: $${SYNAPSE_SERVER_NAME}\n\nlisteners:\n  - port: 8008\n    type: http\n    bind_addresses: ['0.0.0.0']\n    x_forwarded: true\n    resources:\n      - names: [client, federation]\n\nreport_stats: False\n\nlogging:\n  - module: synapse.storage.SQL\n    level: INFO\n\ntrusted_key_servers:\n  - server_name: \"matrix.org\"\nsuppress_key_server_warning: true\n\nenable_registration: false\npassword_config:\n  enabled: false\n\nadmin_contact: 'mailto:$${ADMIN_EMAIL}'\n\nexperimental_features:\n  msc3861:\n    enabled: true\n    issuer: http://synapse-mass-authentication-service:8080\n    client_id: 0000000000000000000SYNAPSE\n    client_auth_method: client_secret_basic\n    client_secret: \"$${SYNAPSE_MAS_SECRET}\"\n    admin_token: \"$${SYNAPSE_API_ADMIN_TOKEN}\"\n    account_management_url: \"$${KEYCLOAK_FQDN}/realms/$${KEYCLOAK_REALM_IDENTIFIER}/account\"\n\napp_service_config_files:\n  - /bridges/whatsapp-registration.yaml\n  - /bridges/telegram-registration.yaml\n  - /bridges/discord-registration.yaml\n  - /bridges/slack-registration.yaml\n  - /bridges/meta-registration.yaml\n  - /bridges/linkedin-registration.yaml\n  - /bridges/maubot-registration.yaml\n  - /bridges/hookshot-registration.yaml\nENDCONF\ncat > /data/config/db.yaml <<ENDCONF\ndatabase:\n  name: psycopg2\n  args:\n    user: $${POSTGRES_SYNAPSE_USER}\n    password: $${POSTGRES_SYNAPSE_PASSWORD}\n    database: $${POSTGRES_SYNAPSE_DB}\n    host: postgres-synapse\n    port: 5432\n    cp_min: 5\n    cp_max: 10\n  allow_unsafe_locale: true\nENDCONF\ncat > /data/config/email.yaml <<ENDCONF\nemail:\n  smtp_host: \"$${SMTP_HOST}\"\n  smtp_port: $${SMTP_PORT}\n  smtp_user: \"$${SMTP_USER}\"\n  smtp_pass: \"$${SMTP_PASSWORD}\"\n  require_transport_security: $${SMTP_REQUIRE_TRANSPORT_SECURITY}\n  notif_from: \"$${SMTP_NOTIFY_FROM}\"\n  app_name: \"$${SYNAPSE_FRIENDLY_SERVER_NAME}\"\nENDCONF\nexec python -m synapse.app.homeserver -c /data/config/homeserver.yaml -c /data/config/db.yaml -c /data/config/email.yaml --keys-directory /data"]
    volumes:
      - synapse-data:/data
      - synapse-media:/media_store
      - bridge-registrations:/bridges:ro
    depends_on:
      postgres-synapse:
        condition: service_healthy
      synapse-mass-authentication-service:
        condition: service_started
      whatsapp-init:
        condition: service_completed_successfully
      telegram-init:
        condition: service_completed_successfully
      discord-init:
        condition: service_completed_successfully
      slack-init:
        condition: service_completed_successfully
      meta-init:
        condition: service_completed_successfully
      linkedin-init:
        condition: service_completed_successfully
      maubot-init:
        condition: service_completed_successfully
      hookshot-init:
        condition: service_completed_successfully

  sliding-sync:
    image: ghcr.io/matrix-org/sliding-sync:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
      postgres-sliding-sync:
        condition: service_healthy
    environment:
      SYNCV3_SERVER: ${SYNAPSE_FQDN}
      SYNCV3_DB: "host=postgres-sliding-sync sslmode=disable port=5432 dbname=${POSTGRES_SLIDING_SYNC_DB} user=${POSTGRES_SLIDING_SYNC_USER} password=${POSTGRES_SLIDING_SYNC_PASSWORD}"
      SYNCV3_SECRET: ${SLIDING_SYNC_SECRET}
      SYNCV3_BINDADDR: 0.0.0.0:8009

  synapse-mass-authentication-service:
    image: ghcr.io/element-hq/matrix-authentication-service:latest
    restart: unless-stopped
    command: ["server", "--config", "/data/config.yaml"]
    depends_on:
      mas-config-init:
        condition: service_completed_successfully
      postgres-synapse-mas:
        condition: service_healthy
    volumes:
      - mas-data:/data

  nginx:
    image: nginx:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
      synapse-mass-authentication-service:
        condition: service_started
    environment:
      SYNAPSE_FQDN: ${SYNAPSE_FQDN}
      SYNAPSE_SYNC_FQDN: ${SYNAPSE_SYNC_FQDN}
      SYNAPSE_MAS_FQDN: ${SYNAPSE_MAS_FQDN}
      AUTHENTICATION_ISSUER: ${AUTHENTICATION_ISSUER}
    entrypoint: ["/bin/sh", "-c", "cat > /etc/nginx/conf.d/default.conf <<'ENDNGINX'\nresolver 127.0.0.11 valid=10s;\n\nserver {\n    listen 80;\n\n    set $$mas_upstream http://synapse-mass-authentication-service:8080;\n    set $$synapse_upstream http://synapse:8008;\n\n    location = /.well-known/matrix/client/index.html {\n        root /usr/share/nginx/html;\n    }\n\n    location ~ ^/_matrix/client/(.*)/(login|logout|refresh) {\n        proxy_http_version 1.1;\n        proxy_pass $$mas_upstream;\n        proxy_set_header X-Forwarded-Proto https;\n        proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;\n    }\n\n    location ~ ^(/|/_matrix|/_synapse/client) {\n        proxy_pass $$synapse_upstream;\n        proxy_set_header X-Forwarded-For $$remote_addr;\n        proxy_set_header X-Forwarded-Proto https;\n        proxy_set_header Host $$host;\n        client_max_body_size 50M;\n        proxy_http_version 1.1;\n    }\n}\nENDNGINX\nmkdir -p /usr/share/nginx/html/.well-known/matrix/client && cat > /usr/share/nginx/html/.well-known/matrix/client/index.html <<ENDHTML\n{\"m.homeserver\":{\"base_url\":\"$${SYNAPSE_FQDN}\"},\"org.matrix.msc3575.proxy\":{\"url\":\"$${SYNAPSE_SYNC_FQDN}\"},\"org.matrix.msc2965.authentication\":{\"issuer\":\"$${AUTHENTICATION_ISSUER}\",\"account\":\"$${SYNAPSE_MAS_FQDN}/account\"}}\nENDHTML\nexec nginx -g 'daemon off;'"]

  postgres-bridges:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: mautrix_whatsapp
      POSTGRES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
    volumes:
      - postgres-bridges:/var/lib/postgresql/data
    entrypoint: ["/bin/sh", "-c", "printf 'CREATE DATABASE mautrix_telegram;\\nCREATE DATABASE mautrix_discord;\\nCREATE DATABASE mautrix_slack;\\nCREATE DATABASE mautrix_meta;\\nCREATE DATABASE mautrix_linkedin;\\nCREATE DATABASE maubot;\\nCREATE DATABASE postmoogle;\\n' > /docker-entrypoint-initdb.d/create-bridge-dbs.sql && exec docker-entrypoint.sh postgres"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_BRIDGES_USER} -d mautrix_whatsapp"]
      interval: 5s
      timeout: 5s
      retries: 10

  whatsapp-init:
    image: dock.mau.dev/mautrix/whatsapp:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "-c", "if [ ! -f /data/config.yaml ]; then\n  /usr/bin/mautrix-whatsapp -c /data/config.yaml -e\nfi\nyq -i '.homeserver.address = \"http://synapse:8008\"' /data/config.yaml\nyq -i '.homeserver.domain = env(SYNAPSE_SERVER_NAME)' /data/config.yaml\nyq -i '.appservice.address = \"http://mautrix-whatsapp:29318\"' /data/config.yaml\nyq -i '.appservice.hostname = \"0.0.0.0\"' /data/config.yaml\nyq -i '.database.type = \"postgres\"' /data/config.yaml\nyq -i '.database.uri = \"postgres://\" + env(POSTGRES_BRIDGES_USER) + \":\" + env(POSTGRES_BRIDGES_PASSWORD) + \"@postgres-bridges:5432/mautrix_whatsapp?sslmode=disable\"' /data/config.yaml\nyq -i '.bridge.permissions = {\"*\": \"relay\", env(SYNAPSE_SERVER_NAME): \"user\", env(BRIDGE_ADMIN_USER): \"admin\"}' /data/config.yaml\nrm -f /data/registration.yaml\n/usr/bin/mautrix-whatsapp -g -c /data/config.yaml -r /data/registration.yaml\nmkdir -p /registrations\ncp /data/registration.yaml /registrations/whatsapp-registration.yaml\nchown -R 1337:1337 /data"]
    volumes:
      - mautrix-whatsapp-data:/data
      - bridge-registrations:/registrations

  telegram-init:
    image: dock.mau.dev/mautrix/telegram:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
      TELEGRAM_API_ID: ${TELEGRAM_API_ID}
      TELEGRAM_API_HASH: ${TELEGRAM_API_HASH}
    entrypoint: ["/bin/bash", "-c", "if [ ! -f /data/config.yaml ]; then\n  cp /opt/mautrix-telegram/example-config.yaml /data/config.yaml\nfi\nyq -i '.homeserver.address = \"http://synapse:8008\"' /data/config.yaml\nyq -i '.homeserver.domain = env(SYNAPSE_SERVER_NAME)' /data/config.yaml\nyq -i '.appservice.address = \"http://mautrix-telegram:29317\"' /data/config.yaml\nyq -i '.appservice.hostname = \"0.0.0.0\"' /data/config.yaml\nyq -i '.appservice.database = \"postgres://\" + env(POSTGRES_BRIDGES_USER) + \":\" + env(POSTGRES_BRIDGES_PASSWORD) + \"@postgres-bridges:5432/mautrix_telegram?sslmode=disable\"' /data/config.yaml\nyq -i '.bridge.permissions = {\"*\": \"relaybot\", env(SYNAPSE_SERVER_NAME): \"full\", env(BRIDGE_ADMIN_USER): \"admin\"}' /data/config.yaml\nyq -i '.telegram.api_id = (env(TELEGRAM_API_ID) | tag = \"!!int\")' /data/config.yaml\nyq -i '.telegram.api_hash = env(TELEGRAM_API_HASH)' /data/config.yaml\nrm -f /data/registration.yaml\npython3 -m mautrix_telegram -g -c /data/config.yaml -r /data/registration.yaml\nmkdir -p /registrations\ncp /data/registration.yaml /registrations/telegram-registration.yaml\nchown -R 1337:1337 /data"]
    volumes:
      - mautrix-telegram-data:/data
      - bridge-registrations:/registrations

  discord-init:
    image: dock.mau.dev/mautrix/discord:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "-c", "if [ ! -f /data/config.yaml ]; then\n  cp /opt/mautrix-discord/example-config.yaml /data/config.yaml\nfi\nyq -i '.homeserver.address = \"http://synapse:8008\"' /data/config.yaml\nyq -i '.homeserver.domain = env(SYNAPSE_SERVER_NAME)' /data/config.yaml\nyq -i '.appservice.address = \"http://mautrix-discord:29334\"' /data/config.yaml\nyq -i '.appservice.hostname = \"0.0.0.0\"' /data/config.yaml\nyq -i '.appservice.database.type = \"postgres\"' /data/config.yaml\nyq -i '.appservice.database.uri = \"postgres://\" + env(POSTGRES_BRIDGES_USER) + \":\" + env(POSTGRES_BRIDGES_PASSWORD) + \"@postgres-bridges:5432/mautrix_discord?sslmode=disable\"' /data/config.yaml\nyq -i '.bridge.permissions = {\"*\": \"relay\", env(SYNAPSE_SERVER_NAME): \"user\", env(BRIDGE_ADMIN_USER): \"admin\"}' /data/config.yaml\nrm -f /data/registration.yaml\n/usr/bin/mautrix-discord -g -c /data/config.yaml -r /data/registration.yaml\nmkdir -p /registrations\ncp /data/registration.yaml /registrations/discord-registration.yaml\nchown -R 1337:1337 /data"]
    volumes:
      - mautrix-discord-data:/data
      - bridge-registrations:/registrations

  slack-init:
    image: dock.mau.dev/mautrix/slack:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "-c", "if [ ! -f /data/config.yaml ]; then\n  /usr/bin/mautrix-slack -c /data/config.yaml -e\nfi\nyq -i '.homeserver.address = \"http://synapse:8008\"' /data/config.yaml\nyq -i '.homeserver.domain = env(SYNAPSE_SERVER_NAME)' /data/config.yaml\nyq -i '.appservice.address = \"http://mautrix-slack:29335\"' /data/config.yaml\nyq -i '.appservice.hostname = \"0.0.0.0\"' /data/config.yaml\nyq -i '.database.type = \"postgres\"' /data/config.yaml\nyq -i '.database.uri = \"postgres://\" + env(POSTGRES_BRIDGES_USER) + \":\" + env(POSTGRES_BRIDGES_PASSWORD) + \"@postgres-bridges:5432/mautrix_slack?sslmode=disable\"' /data/config.yaml\nyq -i '.bridge.permissions = {\"*\": \"relay\", env(SYNAPSE_SERVER_NAME): \"user\", env(BRIDGE_ADMIN_USER): \"admin\"}' /data/config.yaml\nrm -f /data/registration.yaml\n/usr/bin/mautrix-slack -g -c /data/config.yaml -r /data/registration.yaml\nmkdir -p /registrations\ncp /data/registration.yaml /registrations/slack-registration.yaml\nchown -R 1337:1337 /data"]
    volumes:
      - mautrix-slack-data:/data
      - bridge-registrations:/registrations

  meta-init:
    image: dock.mau.dev/mautrix/meta:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "-c", "if [ ! -f /data/config.yaml ]; then\n  /usr/bin/mautrix-meta -c /data/config.yaml -e\nfi\nyq -i '.homeserver.address = \"http://synapse:8008\"' /data/config.yaml\nyq -i '.homeserver.domain = env(SYNAPSE_SERVER_NAME)' /data/config.yaml\nyq -i '.appservice.address = \"http://mautrix-meta:29319\"' /data/config.yaml\nyq -i '.appservice.hostname = \"0.0.0.0\"' /data/config.yaml\nyq -i '.database.type = \"postgres\"' /data/config.yaml\nyq -i '.database.uri = \"postgres://\" + env(POSTGRES_BRIDGES_USER) + \":\" + env(POSTGRES_BRIDGES_PASSWORD) + \"@postgres-bridges:5432/mautrix_meta?sslmode=disable\"' /data/config.yaml\nyq -i '.bridge.permissions = {\"*\": \"relay\", env(SYNAPSE_SERVER_NAME): \"user\", env(BRIDGE_ADMIN_USER): \"admin\"}' /data/config.yaml\nrm -f /data/registration.yaml\n/usr/bin/mautrix-meta -g -c /data/config.yaml -r /data/registration.yaml\nmkdir -p /registrations\ncp /data/registration.yaml /registrations/meta-registration.yaml\nchown -R 1337:1337 /data"]
    volumes:
      - mautrix-meta-data:/data
      - bridge-registrations:/registrations

  linkedin-init:
    image: dock.mau.dev/mautrix/linkedin:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/bash", "-c", "if [ ! -f /data/config.yaml ]; then\n  /usr/bin/mautrix-linkedin -c /data/config.yaml -e\nfi\nyq -i '.homeserver.address = \"http://synapse:8008\"' /data/config.yaml\nyq -i '.homeserver.domain = env(SYNAPSE_SERVER_NAME)' /data/config.yaml\nyq -i '.appservice.address = \"http://mautrix-linkedin:29341\"' /data/config.yaml\nyq -i '.appservice.hostname = \"0.0.0.0\"' /data/config.yaml\nyq -i '.database.type = \"postgres\"' /data/config.yaml\nyq -i '.database.uri = \"postgres://\" + env(POSTGRES_BRIDGES_USER) + \":\" + env(POSTGRES_BRIDGES_PASSWORD) + \"@postgres-bridges:5432/mautrix_linkedin?sslmode=disable\"' /data/config.yaml\nyq -i '.bridge.permissions = {\"*\": \"relay\", env(SYNAPSE_SERVER_NAME): \"user\", env(BRIDGE_ADMIN_USER): \"admin\"}' /data/config.yaml\nrm -f /data/registration.yaml\n/usr/bin/mautrix-linkedin -g -c /data/config.yaml -r /data/registration.yaml\nmkdir -p /registrations\ncp /data/registration.yaml /registrations/linkedin-registration.yaml\nchown -R 1337:1337 /data"]
    volumes:
      - mautrix-linkedin-data:/data
      - bridge-registrations:/registrations

  maubot-init:
    image: dock.mau.dev/maubot/maubot:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      SYNAPSE_FQDN: ${SYNAPSE_FQDN}
      POSTGRES_BRIDGES_USER: ${POSTGRES_BRIDGES_USER}
      POSTGRES_BRIDGES_PASSWORD: ${POSTGRES_BRIDGES_PASSWORD}
      MAUBOT_ADMIN_PASSWORD: ${MAUBOT_ADMIN_PASSWORD}
    entrypoint: ["/bin/bash", "-c", "if [ ! -f /data/config.yaml ]; then\n  cp /opt/maubot/example-config.yaml /data/config.yaml\nfi\nyq -i '.database = \"postgresql://\" + env(POSTGRES_BRIDGES_USER) + \":\" + env(POSTGRES_BRIDGES_PASSWORD) + \"@postgres-bridges:5432/maubot\"' /data/config.yaml\nyq -i '.plugin_databases.postgres = \"postgresql://\" + env(POSTGRES_BRIDGES_USER) + \":\" + env(POSTGRES_BRIDGES_PASSWORD) + \"@postgres-bridges:5432/maubot\"' /data/config.yaml\nyq -i '.server.hostname = \"0.0.0.0\"' /data/config.yaml\nyq -i '.server.port = 29316' /data/config.yaml\nyq -i '.server.public_url = env(SYNAPSE_FQDN)' /data/config.yaml\nyq -i '.server.ui_base_path = \"/_matrix/maubot\"' /data/config.yaml\nyq -i '.homeservers = {env(SYNAPSE_SERVER_NAME): {\"url\": \"http://synapse:8008\", \"secret\": null}}' /data/config.yaml\nyq -i '.admins.root = env(MAUBOT_ADMIN_PASSWORD)' /data/config.yaml\nyq -i '.api_features.login = true' /data/config.yaml\nmkdir -p /data/plugins /data/trash /data/dbs\nif [ ! -f /data/registration.yaml ]; then\n  python3 -c \"\nimport yaml, secrets\nreg = {\n  'id': 'maubot',\n  'url': 'http://maubot:29316',\n  'as_token': secrets.token_hex(32),\n  'hs_token': secrets.token_hex(32),\n  'sender_localpart': 'maubot',\n  'namespaces': {'users': [{'regex': '@maubot_.*:' + '$(echo $SYNAPSE_SERVER_NAME | sed \"s/\\\\./\\\\\\\\./g\")', 'exclusive': true}], 'rooms': [], 'aliases': []},\n  'rate_limited': False,\n  'de.sorunome.msc2409.push_ephemeral': True,\n  'push_ephemeral': True\n}\nwith open('/data/registration.yaml', 'w') as f:\n  yaml.dump(reg, f)\n\"\nfi\nmkdir -p /registrations\ncp /data/registration.yaml /registrations/maubot-registration.yaml\nchown -R 1337:1337 /data"]
    volumes:
      - maubot-data:/data
      - bridge-registrations:/registrations

  hookshot-init:
    image: halfshot/matrix-hookshot:latest
    user: "0:0"
    restart: "no"
    depends_on:
      postgres-bridges:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
    entrypoint: ["/bin/sh", "-c", "mkdir -p /data\nif [ ! -f /data/passkey.pem ]; then\n  openssl genpkey -out /data/passkey.pem -outform PEM -algorithm RSA -pkeyopt rsa_keygen_bits:4096 2>/dev/null\nfi\ncat > /data/config.yml <<ENDCONF\nbridge:\n  domain: $${SYNAPSE_SERVER_NAME}\n  url: http://synapse:8008\n  mediaUrl: https://$${SYNAPSE_SERVER_NAME}\n  port: 9993\n  bindAddress: 0.0.0.0\nlogging:\n  level: info\n  colorize: true\n  json: false\n  timestampFormat: HH:mm:ss:SSS\npassFile: /data/passkey.pem\nlisteners:\n  - port: 9000\n    bindAddress: 0.0.0.0\n    resources:\n      - webhooks\n  - port: 9002\n    bindAddress: 0.0.0.0\n    resources:\n      - widgets\npermissions:\n  - actor: $${SYNAPSE_SERVER_NAME}\n    services:\n      - service: \"*\"\n        level: admin\ngeneric:\n  enabled: true\n  outbound: false\n  urlPrefix: https://$${SYNAPSE_SERVER_NAME}/hookshot/\n  userIdPrefix: _hookshot_\n  allowJsTransformationFunctions: false\nfeeds:\n  enabled: true\n  pollIntervalSeconds: 600\n  pollTimeoutSeconds: 30\nbot:\n  displayname: Hookshot Bot\nENDCONF\nif [ ! -f /data/registration.yml ]; then\n  AS_TOKEN=$(cat /dev/urandom | tr -dc 'a-f0-9' | head -c 64)\n  HS_TOKEN=$(cat /dev/urandom | tr -dc 'a-f0-9' | head -c 64)\n  ESCAPED_DOMAIN=$(echo $${SYNAPSE_SERVER_NAME} | sed 's/\\./\\\\./g')\n  cat > /data/registration.yml <<ENDREG\nid: matrix-hookshot\nas_token: $${AS_TOKEN}\nhs_token: $${HS_TOKEN}\nnamespaces:\n  rooms: []\n  users:\n    - regex: \"@_hookshot_.*:$${ESCAPED_DOMAIN}\"\n      exclusive: true\n    - regex: \"@feeds:$${ESCAPED_DOMAIN}\"\n      exclusive: true\n  aliases: []\nsender_localpart: hookshot\nurl: \"http://hookshot:9993\"\nrate_limited: false\nde.sorunome.msc2409.push_ephemeral: true\npush_ephemeral: true\nENDREG\nfi\nmkdir -p /registrations\ncp /data/registration.yml /registrations/hookshot-registration.yaml\nchown -R 1000:1000 /data"]
    volumes:
      - hookshot-data:/data
      - bridge-registrations:/registrations

  mautrix-whatsapp:
    image: dock.mau.dev/mautrix/whatsapp:latest
    restart: unless-stopped
    depends_on:
      whatsapp-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-whatsapp-data:/data

  mautrix-telegram:
    image: dock.mau.dev/mautrix/telegram:latest
    restart: unless-stopped
    depends_on:
      telegram-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-telegram-data:/data

  mautrix-discord:
    image: dock.mau.dev/mautrix/discord:latest
    restart: unless-stopped
    depends_on:
      discord-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-discord-data:/data

  mautrix-slack:
    image: dock.mau.dev/mautrix/slack:latest
    restart: unless-stopped
    depends_on:
      slack-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-slack-data:/data

  mautrix-meta:
    image: dock.mau.dev/mautrix/meta:latest
    restart: unless-stopped
    depends_on:
      meta-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-meta-data:/data

  mautrix-linkedin:
    image: dock.mau.dev/mautrix/linkedin:latest
    restart: unless-stopped
    depends_on:
      linkedin-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - mautrix-linkedin-data:/data

  maubot:
    image: dock.mau.dev/maubot/maubot:latest
    restart: unless-stopped
    depends_on:
      maubot-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    volumes:
      - maubot-data:/data

  hookshot:
    image: halfshot/matrix-hookshot:latest
    restart: unless-stopped
    depends_on:
      hookshot-init:
        condition: service_completed_successfully
      synapse:
        condition: service_started
    command: ["node", "/usr/bin/matrix-hookshot/App/BridgeApp.js", "--config", "/data/config.yml", "--registration", "/data/registration.yml"]
    volumes:
      - hookshot-data:/data

  postmoogle:
    image: registry.gitlab.com/etke.cc/postmoogle:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
      postgres-bridges:
        condition: service_healthy
    environment:
      POSTMOOGLE_HOMESERVER: http://synapse:8008
      POSTMOOGLE_LOGIN: postmoogle
      POSTMOOGLE_SHAREDSECRET: ${SYNAPSE_API_ADMIN_TOKEN}
      POSTMOOGLE_DOMAINS: ${SYNAPSE_SERVER_NAME}
      POSTMOOGLE_PORT: "25"
      POSTMOOGLE_DATA_SECRET: ${POSTMOOGLE_DATA_SECRET}
      POSTMOOGLE_DB_DSN: "postgres://${POSTGRES_BRIDGES_USER}:${POSTGRES_BRIDGES_PASSWORD}@postgres-bridges:5432/postmoogle?sslmode=disable"
      POSTMOOGLE_DB_DIALECT: postgres
      POSTMOOGLE_ADMINS: ${BRIDGE_ADMIN_USER}
      POSTMOOGLE_LOGLEVEL: info
    ports:
      - "25:25"

  dimension:
    image: turt2live/matrix-dimension:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      BRIDGE_ADMIN_USER: ${BRIDGE_ADMIN_USER}
      DIMENSION_ACCESS_TOKEN: ${DIMENSION_ACCESS_TOKEN}
      DIMENSION_PUBLIC_URL: ${DIMENSION_PUBLIC_URL}
    volumes:
      - dimension-data:/data
    entrypoint: ["/bin/sh", "-c", "cat > /home/node/matrix-dimension/config/production.yaml <<ENDCONF\nweb:\n  port: 8184\n  address: '0.0.0.0'\nhomeserver:\n  name: \"$${SYNAPSE_SERVER_NAME}\"\n  clientServerUrl: \"http://synapse:8008\"\n  accessToken: \"$${DIMENSION_ACCESS_TOKEN}\"\nadmins:\n  - \"$${BRIDGE_ADMIN_USER}\"\ndatabase:\n  file: \"dimension.db\"\n  botData: \"dimension.bot.json\"\nstickers:\n  enabled: true\n  stickerBot: \"@stickers:t2bot.io\"\n  managerUrl: \"https://stickers.t2bot.io\"\ndimension:\n  publicUrl: \"$${DIMENSION_PUBLIC_URL}\"\nENDCONF\nexec node /home/node/matrix-dimension/build/app/index.js -p 8184"]

volumes:
  postgres-synapse:
  postgres-sliding-sync:
  postgres-synapse-mas:
  synapse-data:
  synapse-media:
  mas-data:
  postgres-bridges:
  bridge-registrations:
  mautrix-whatsapp-data:
  mautrix-telegram-data:
  mautrix-discord-data:
  mautrix-slack-data:
  mautrix-meta-data:
  mautrix-linkedin-data:
  maubot-data:
  hookshot-data:
  dimension-data:
