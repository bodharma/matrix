services:
  postgres-synapse:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_SYNAPSE_DB}
      POSTGRES_USER: ${POSTGRES_SYNAPSE_USER}
      POSTGRES_PASSWORD: ${POSTGRES_SYNAPSE_PASSWORD}
    volumes:
      - postgres-synapse:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SYNAPSE_USER} -d ${POSTGRES_SYNAPSE_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-sliding-sync:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_SLIDING_SYNC_DB}
      POSTGRES_USER: ${POSTGRES_SLIDING_SYNC_USER}
      POSTGRES_PASSWORD: ${POSTGRES_SLIDING_SYNC_PASSWORD}
    volumes:
      - postgres-sliding-sync:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SLIDING_SYNC_USER} -d ${POSTGRES_SLIDING_SYNC_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-synapse-mas:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_SYNAPSE_MAS_DB}
      POSTGRES_USER: ${POSTGRES_SYNAPSE_MAS_USER}
      POSTGRES_PASSWORD: ${POSTGRES_SYNAPSE_MAS_PASSWORD}
    volumes:
      - postgres-synapse-mas:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SYNAPSE_MAS_USER} -d ${POSTGRES_SYNAPSE_MAS_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  mas-config-init:
    image: ghcr.io/element-hq/matrix-authentication-service:latest-debug
    user: "0:0"
    restart: "no"
    environment:
      POSTGRES_SYNAPSE_MAS_USER: ${POSTGRES_SYNAPSE_MAS_USER}
      POSTGRES_SYNAPSE_MAS_PASSWORD: ${POSTGRES_SYNAPSE_MAS_PASSWORD}
      POSTGRES_SYNAPSE_MAS_DB: ${POSTGRES_SYNAPSE_MAS_DB}
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      SYNAPSE_FQDN: ${SYNAPSE_FQDN}
      SYNAPSE_MAS_FQDN: ${SYNAPSE_MAS_FQDN}
      SYNAPSE_MAS_SECRET: ${SYNAPSE_MAS_SECRET}
      SYNAPSE_API_ADMIN_TOKEN: ${SYNAPSE_API_ADMIN_TOKEN}
      SYNAPSE_FRIENDLY_SERVER_NAME: ${SYNAPSE_FRIENDLY_SERVER_NAME}
      SMTP_USER: ${SMTP_USER}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      KEYCLOAK_FQDN: ${KEYCLOAK_FQDN}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      KEYCLOAK_REALM_IDENTIFIER: ${KEYCLOAK_REALM_IDENTIFIER}
      KEYCLOAK_UPSTREAM_OAUTH_PROVIDER_ID: ${KEYCLOAK_UPSTREAM_OAUTH_PROVIDER_ID}
    entrypoint: ["/busybox/sh", "-c", "if [ -f /data/config.yaml ]; then\n  echo 'Config already exists, skipping generation'\n  exit 0\nfi\necho 'Generating MAS config...'\nmas-cli config generate --output /data/config.yaml\nsed -i \"s|uri: postgresql://.*|uri: postgresql://$${POSTGRES_SYNAPSE_MAS_USER}:$${POSTGRES_SYNAPSE_MAS_PASSWORD}@postgres-synapse-mas:5432/$${POSTGRES_SYNAPSE_MAS_DB}|\" /data/config.yaml\nsed -i \"s|from: .*Authentication Service.*|from: '\\\"$${SYNAPSE_FRIENDLY_SERVER_NAME}\\\" <$${SMTP_USER}>'|\" /data/config.yaml\nsed -i \"s|reply_to: .*Authentication Service.*|reply_to: '\\\"$${SYNAPSE_FRIENDLY_SERVER_NAME}\\\" <$${ADMIN_EMAIL}>'|\" /data/config.yaml\nsed -i \"s|homeserver: localhost:8008|homeserver: $${SYNAPSE_SERVER_NAME}|\" /data/config.yaml\nsed -i \"s|endpoint: http://localhost:8008/|endpoint: $${SYNAPSE_FQDN}|\" /data/config.yaml\nsed -i '/^matrix:/,/^[^ ]/{/^  secret:/s|secret: .*|secret: '\"$${SYNAPSE_API_ADMIN_TOKEN}\"'|}' /data/config.yaml\nsed -i \"s|public_base: http://\\[::]:8080/|public_base: $${SYNAPSE_MAS_FQDN}/|\" /data/config.yaml\nsed -i \"s|issuer: http://\\[::]:8080/|issuer: $${SYNAPSE_MAS_FQDN}/|\" /data/config.yaml\nsed -i '/^passwords:/{n;s/enabled: true/enabled: false/}' /data/config.yaml\ncat >> /data/config.yaml <<ENDAPPEND\nclients:\n  - client_id: 0000000000000000000SYNAPSE\n    client_auth_method: client_secret_basic\n    client_secret: \"$${SYNAPSE_MAS_SECRET}\"\nupstream_oauth2:\n  providers:\n    - id: \"$${KEYCLOAK_UPSTREAM_OAUTH_PROVIDER_ID}\"\n      issuer: \"$${KEYCLOAK_FQDN}/realms/$${KEYCLOAK_REALM_IDENTIFIER}\"\n      token_endpoint_auth_method: client_secret_basic\n      client_id: \"$${KEYCLOAK_CLIENT_ID}\"\n      client_secret: \"$${KEYCLOAK_CLIENT_SECRET}\"\n      scope: \"openid profile email\"\n      claims_imports:\n        localpart:\n          action: require\n          template: \"{{ user.preferred_username }}\"\n        displayname:\n          action: suggest\n          template: \"{{ user.name }}\"\n        email:\n          action: suggest\n          template: \"{{ user.email }}\"\n          set_email_verification: always\nENDAPPEND\nchown -R 65532:65532 /data\necho 'MAS config generated successfully'"]
    volumes:
      - mas-data:/data

  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    environment:
      SYNAPSE_SERVER_NAME: ${SYNAPSE_SERVER_NAME}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      POSTGRES_SYNAPSE_USER: ${POSTGRES_SYNAPSE_USER}
      POSTGRES_SYNAPSE_PASSWORD: ${POSTGRES_SYNAPSE_PASSWORD}
      POSTGRES_SYNAPSE_DB: ${POSTGRES_SYNAPSE_DB}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_REQUIRE_TRANSPORT_SECURITY: ${SMTP_REQUIRE_TRANSPORT_SECURITY}
      SMTP_NOTIFY_FROM: ${SMTP_NOTIFY_FROM}
      SYNAPSE_FRIENDLY_SERVER_NAME: ${SYNAPSE_FRIENDLY_SERVER_NAME}
      SYNAPSE_MAS_FQDN: ${SYNAPSE_MAS_FQDN}
      SYNAPSE_MAS_SECRET: ${SYNAPSE_MAS_SECRET}
      SYNAPSE_API_ADMIN_TOKEN: ${SYNAPSE_API_ADMIN_TOKEN}
      KEYCLOAK_FQDN: ${KEYCLOAK_FQDN}
      KEYCLOAK_REALM_IDENTIFIER: ${KEYCLOAK_REALM_IDENTIFIER}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
    entrypoint: ["/bin/sh", "-c", "mkdir -p /data/config && cat > /data/config/homeserver.yaml <<ENDCONF\nserver_name: $${SYNAPSE_SERVER_NAME}\n\nlisteners:\n  - port: 8008\n    type: http\n    bind_addresses: ['0.0.0.0']\n    x_forwarded: true\n    resources:\n      - names: [client, federation]\n\nreport_stats: False\n\nlogging:\n  - module: synapse.storage.SQL\n    level: INFO\n\ntrusted_key_servers:\n  - server_name: \"matrix.org\"\nsuppress_key_server_warning: true\n\nenable_registration: false\npassword_config:\n  enabled: false\n\nadmin_contact: 'mailto:$${ADMIN_EMAIL}'\n\nexperimental_features:\n  msc3861:\n    enabled: true\n    issuer: http://synapse-mass-authentication-service:8080\n    client_id: 0000000000000000000SYNAPSE\n    client_auth_method: client_secret_basic\n    client_secret: \"$${SYNAPSE_MAS_SECRET}\"\n    admin_token: \"$${SYNAPSE_API_ADMIN_TOKEN}\"\n    account_management_url: \"$${KEYCLOAK_FQDN}/realms/$${KEYCLOAK_REALM_IDENTIFIER}/account\"\nENDCONF\ncat > /data/config/db.yaml <<ENDCONF\ndatabase:\n  name: psycopg2\n  args:\n    user: $${POSTGRES_SYNAPSE_USER}\n    password: $${POSTGRES_SYNAPSE_PASSWORD}\n    database: $${POSTGRES_SYNAPSE_DB}\n    host: postgres-synapse\n    port: 5432\n    cp_min: 5\n    cp_max: 10\n  allow_unsafe_locale: true\nENDCONF\ncat > /data/config/email.yaml <<ENDCONF\nemail:\n  smtp_host: \"$${SMTP_HOST}\"\n  smtp_port: $${SMTP_PORT}\n  smtp_user: \"$${SMTP_USER}\"\n  smtp_pass: \"$${SMTP_PASSWORD}\"\n  require_transport_security: $${SMTP_REQUIRE_TRANSPORT_SECURITY}\n  notif_from: \"$${SMTP_NOTIFY_FROM}\"\n  app_name: \"$${SYNAPSE_FRIENDLY_SERVER_NAME}\"\nENDCONF\nexec python -m synapse.app.homeserver -c /data/config/homeserver.yaml -c /data/config/db.yaml -c /data/config/email.yaml --keys-directory /data"]
    volumes:
      - synapse-data:/data
      - synapse-media:/media_store
    depends_on:
      postgres-synapse:
        condition: service_healthy
      synapse-mass-authentication-service:
        condition: service_started

  sliding-sync:
    image: ghcr.io/matrix-org/sliding-sync:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
      postgres-sliding-sync:
        condition: service_healthy
    environment:
      SYNCV3_SERVER: ${SYNAPSE_FQDN}
      SYNCV3_DB: "host=postgres-sliding-sync sslmode=disable port=5432 dbname=${POSTGRES_SLIDING_SYNC_DB} user=${POSTGRES_SLIDING_SYNC_USER} password=${POSTGRES_SLIDING_SYNC_PASSWORD}"
      SYNCV3_SECRET: ${SLIDING_SYNC_SECRET}
      SYNCV3_BINDADDR: 0.0.0.0:8009

  synapse-mass-authentication-service:
    image: ghcr.io/element-hq/matrix-authentication-service:latest
    restart: unless-stopped
    command: ["server", "--config", "/data/config.yaml"]
    depends_on:
      mas-config-init:
        condition: service_completed_successfully
      postgres-synapse-mas:
        condition: service_healthy
    volumes:
      - mas-data:/data

  nginx:
    image: nginx:latest
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_started
      synapse-mass-authentication-service:
        condition: service_started
    environment:
      SYNAPSE_FQDN: ${SYNAPSE_FQDN}
      SYNAPSE_SYNC_FQDN: ${SYNAPSE_SYNC_FQDN}
      SYNAPSE_MAS_FQDN: ${SYNAPSE_MAS_FQDN}
      AUTHENTICATION_ISSUER: ${AUTHENTICATION_ISSUER}
    entrypoint: ["/bin/sh", "-c", "cat > /etc/nginx/conf.d/default.conf <<'ENDNGINX'\nresolver 127.0.0.11 valid=10s;\n\nserver {\n    listen 80;\n\n    set $$mas_upstream http://synapse-mass-authentication-service:8080;\n    set $$synapse_upstream http://synapse:8008;\n\n    location = /.well-known/matrix/client/index.html {\n        root /usr/share/nginx/html;\n    }\n\n    location ~ ^/_matrix/client/(.*)/(login|logout|refresh) {\n        proxy_http_version 1.1;\n        proxy_pass $$mas_upstream;\n        proxy_set_header X-Forwarded-Proto https;\n        proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;\n    }\n\n    location ~ ^(/|/_matrix|/_synapse/client) {\n        proxy_pass $$synapse_upstream;\n        proxy_set_header X-Forwarded-For $$remote_addr;\n        proxy_set_header X-Forwarded-Proto https;\n        proxy_set_header Host $$host;\n        client_max_body_size 50M;\n        proxy_http_version 1.1;\n    }\n}\nENDNGINX\nmkdir -p /usr/share/nginx/html/.well-known/matrix/client && cat > /usr/share/nginx/html/.well-known/matrix/client/index.html <<ENDHTML\n{\"m.homeserver\":{\"base_url\":\"$${SYNAPSE_FQDN}\"},\"org.matrix.msc3575.proxy\":{\"url\":\"$${SYNAPSE_SYNC_FQDN}\"},\"org.matrix.msc2965.authentication\":{\"issuer\":\"$${AUTHENTICATION_ISSUER}\",\"account\":\"$${SYNAPSE_MAS_FQDN}/account\"}}\nENDHTML\nexec nginx -g 'daemon off;'"]

volumes:
  postgres-synapse:
  postgres-sliding-sync:
  postgres-synapse-mas:
  synapse-data:
  synapse-media:
  mas-data:
